---
title: "Airbnb Seattle"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: false
    toc_depth: 1
    #code_folding: hide
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(lubridate)
library(gridExtra)
library(mapview)
library(ggmap)
library(leaflet)
```


```{r, cache=TRUE}
listings = read.csv("/Users/joshupadhyay/Downloads/seattle/listings.csv")
reviews = read.csv("/Users/joshupadhyay/Downloads/seattle/reviews.csv")
calendar = read.csv("/Users/joshupadhyay/Downloads/seattle/calendar.csv")
```

```{r}
#cleaning up listings price

listings$price = as.numeric(gsub("\\$", "", listings$price))
listings$weekly_price = as.numeric(gsub("\\$", "", listings$weekly_price))
listings$monthly_price = as.numeric(gsub("\\$", "", listings$monthly_price))
listings$cleaning_fee = as.numeric(gsub("\\$", "", listings$cleaning_fee))


```

```{r, echo=FALSE}

#cleaning up reviews
reviews$date <- as.Date(reviews$date)

reviews <- reviews %>%
  mutate(month = format(date, "%m"), year = format(date, "%Y"))

```


```{r, cache=TRUE}

reviewed_listings <- listings %>%
  left_join(reviews, by = c('id' = 'listing_id'))



```


# An Overview:
```{r, cache = TRUE}
housing_points <- reviewed_listings %>%
  distinct(longitude, latitude, .keep_all = TRUE)


qmplot(longitude, latitude, data = housing_points, zoom = 10) 

#figure out how to change alpha and point size, also you used to use a better map package.. mapview? edit this either way... also have it interactive so it looks good 

```


```{r}
library(wesanderson)


ptypes = c("Apartment", "House", "Cabin", "Condominium", "Camper/RV", "Bungalow", "Townhouse", "Loft", "Boat", "Bed & Breakfast", "Other", "Dorm", "Treehouse", "Yurt", "Chalet", "Tent")


leaflet(housing_points) %>%
  addProviderTiles(providers$CartoDB) %>%
  setView(-122.3672, 47.61068 , zoom = 10.5) %>%
  addCircleMarkers(housing_points$longitude, housing_points$latitude, weight = 3, radius = 2, fillOpacity = 0.4, popup = housing_points$property_type, color = wes_palette("Royal1", 16, type = c('continuous')))
```


The data represents a year's worth of Airbnb bookings and reviews starting from Jan 16th, 2016. Using the data provided, I aim to leverage the data to help both hosts and guests. 



# When are Airbnbs the busiest? 

```{r, cache= TRUE}


n_reviewers <- reviews %>%
  group_by(month) %>%
  summarize(nreviewers = n()) %>%
  ggplot() + geom_point(aes(x = month, y = nreviewers)) + labs(title = 'Number of Reviewers by Month', subtitle = 'Counted, separated by month')

```


```{r}
n_reviewers
```

Given that AirBnb review requests are sent to people immediately after they stay in the booking, I've made the assumption that all reviews have been made right after people exited their AirBnb. Based on this, it seems as though August is the time that most people stay in an Airbnb. 

```{r}
#dummy var.. probably a MUCH faster way to do this exists
calendar <- calendar %>% 
  mutate(avail_n = replace(calendar$availible, calendar$available == 'f', 0))
calendar$avail_n <- replace_na(calendar$avail_n, 1)

calendar$date <- ymd(calendar$date)
```

```{r}
calendar <- calendar %>%
  mutate(d_month = format(date, "%m"), d_year = format(date, "%y"))

```


```{r}
booked_month <- calendar %>%
  group_by(listing_id, d_month) %>%
  summarize(percent_booked = 1 - (sum(avail_n) / (365)))

# Added up all the days the Airbnb was availible and divided by a year, then did 1 minus that to get the percentage booked

booked_month
```

```{r, cache=TRUE}
id3335 <- booked_month %>%
  filter(listing_id == 3335) %>%
  ggplot() + geom_point(aes(d_month, y = percent_booked)) + labs(title = "ID 3335")

id2800448 <- booked_month %>%
  filter(listing_id == 2800448) %>%
  ggplot() + geom_point(aes(d_month, y = percent_booked)) + labs(title = "ID 2800448")

id2830174 <- booked_month %>%
  filter(listing_id == 2830174) %>%
  ggplot() + geom_point(aes(d_month, y = percent_booked)) + labs(title = "ID 2830174")

id6411259 <- booked_month %>%
  filter(listing_id == 6411259) %>%
  ggplot() + geom_point(aes(d_month, y = percent_booked)) + labs(title = "ID 6411259")

grid.arrange(id3335,id2800448, id2830174,id6411259)
```

Interestingly, various AirBnbs are booked up at different times of the year - I wonder if this matters depending on location? (All 4 also seem to be highly booked up in January). To be honest, I didn't expect a low of only 91% - I'm sure these AirBnb hosts are making good money. 


```{r}
book_percentage <- booked_month %>%
  group_by(d_month) %>%
  summarize(agg = mean(percent_booked)) %>%
  ggplot() + geom_point(aes(d_month, agg)) + labs(x = "Month", y = "Average % Booked", title = "How Full are AirBnbs In Seattle?", subtitle = "Jan 17, 2016 - 2017")
```


Interestingly, if we assume people write a review right after they stay, (speaking from AirBnb experience, they send an email right after you leave - if you don't write a review then, you most likely won't) we can see two different trends between the "number of reviewers" and the fullness of AirBnbs:
```{r}
grid.arrange(book_percentage, n_reviewers)
```

While Airbnbs are more full in January, it appears that there are more unique reviewers in August. This may indicate a higher turnover rate in August with shorter stays per guest compared to fewer, longer-staying guests in Janurary. 

# How much to charge / How much to pay?

Let's quickly break down the average price by neighborhood (I'll deal with amenities and so forth later): 
```{r}
reviewed_listings %>%
  distinct(id, .keep_all = TRUE) %>%
  group_by(neighbourhood, property_type) %>%
  summarize(avg_p = mean(price))

```




